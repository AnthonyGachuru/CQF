\documentclass[a4paper,11pt] {article}
\usepackage{graphicx}
\usepackage{amssymb, amsmath, amsthm}
\usepackage{setspace}
\usepackage{amsfonts}

%-----------Margin, Linespread, Spacing-----------%
\usepackage[letterpaper, margin=1.3in]{geometry}
\usepackage[letterpaper]{geometry}
\linespread{1}
%-------------------------------------------------%

%-----------Define header and footnotes-----------
\usepackage{fancyhdr}               % Header and footnotes
\pagestyle{fancy}
\lhead{\bfseries \scriptsize CQF}
\chead{\bfseries \scriptsize Module 2 Solution}
\rhead{\bfseries \scriptsize Ran Zhao}
\renewcommand{\headrulewidth}{0.4pt}
%-------------------------------------------------%

%---------------------Listings--------------------%
\usepackage{listings}
\usepackage{color}
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\lstset{ %
  language=Octave,                % the language of the code
  basicstyle=\footnotesize,           % the size of the fonts that are used for the code
  numbers=left,                   % where to put the line-numbers
  numberstyle=\tiny\color{gray},  % the style that is used for the line-numbers
  stepnumber=2,                   % the step between two line-numbers. If it's 1, each line
                                  % will be numbered
  numbersep=5pt,                  % how far the line-numbers are from the code
  backgroundcolor=\color{white},      % choose the background color. You must add \usepackage{color}
  showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  showtabs=false,                 % show tabs within strings adding particular underscores
  frame=single,                   % adds a frame around the code
  rulecolor=\color{black},        % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
  tabsize=2,                      % sets default tabsize to 2 spaces
  captionpos=b,                   % sets the caption-position to bottom
  breaklines=true,                % sets automatic line breaking
  breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
  title=\lstname,                   % show the filename of files included with \lstinputlisting;
                                  % also try caption instead of title
  keywordstyle=\color{blue},          % keyword style
  commentstyle=\color{dkgreen},       % comment style
  stringstyle=\color{mauve},         % string literal style
  escapeinside={\%*}{*)},            % if you want to add LaTeX within your code
  morekeywords={*,...}               % if you want to add more keywords to the set
}
%-------------------------------------------------%

%----------------Title, Author, Dates-------------
\author{Ran Zhao}
\title{CQF Module 2 Exercise Solution}
\date{}
\begin{document}
\maketitle
%--------------------------------------------------


\section*{A. Optimal Portfolio Allocations}
\textcolor{blue}{\bf 1 } To solve for the weight in global minimum variance portfolio, we formulate
\begin{equation*}
\begin{aligned}
& \underset{\mathbf{\omega}}{\text{argmin}} & & \frac{1}{2}\mathbf{\omega}'\Sigma\mathbf{\omega} \\
& \text{subject to}
& & \mathbf{\omega}'\mathbf{1} = 1
\end{aligned}
\end{equation*}

The Lagrangian multiplier of this global minimum variance portfolio is
$$
L(\mathbf{\omega}, \lambda) = \frac{1}{2}\mathbf{\omega}'\Sigma\mathbf{\omega} + \lambda(\mathbf{\omega}'\mathbf{1} - 1) = 0
$$

Set the FOCs to zero yields the optimal solution of the weight:

\begin{eqnarray}
\frac{\partial L}{\partial \mathbf{\omega}} &=& \Sigma \mathbf{\omega} + \lambda \mathbf{1} = 0 \\
\frac{\partial L}{\partial \lambda} &=& \omega'\mathbf{1} - 1 = 0
\end{eqnarray}

From (5), the optimal weight solution has
\begin{equation}
\mathbf{\omega}^* = -\Sigma^{-1} \lambda \mathbf{1}
\end{equation}

Bring this into (6), we have
\begin{equation}
\mathbf{\omega}^{*'} \mathbf{1} = -\lambda \mathbf{1}' \Sigma^{-1} \mathbf{1} = 1 \quad \Rightarrow \quad \lambda^* = -\frac{1}{\mathbf{1}'\Sigma^{-1}\mathbf{1}}
\end{equation}

Combine (4) with (3), the analytical solution for optimal allocations $\omega^*$ is
$$
\mathbf{\omega}^* = \frac{\Sigma^{-1}\mathbf{1}}{\mathbf{1}'\Sigma^{-1}\mathbf{1}}
$$

\textcolor{blue}{\bf 2.a } To solve for the minimum variance portfolio under the target return with risk-free asset, we formulate
\begin{equation*}
\begin{aligned}
& \underset{\mathbf{\omega}}{\text{argmin}} & & \frac{1}{2}\mathbf{\omega}'\Sigma\mathbf{\omega} \\
& \text{subject to}
& & r + (\mu-r\mathbf{1})\mathbf{\omega}' = 0.1
\end{aligned}
\end{equation*}

The Lagrangian multiplier of this global minimum variance portfolio is
$$
L(\mathbf{\omega}, \lambda) = \frac{1}{2}\mathbf{\omega}'\Sigma\mathbf{\omega} + \lambda[r + (\mu-r\mathbf{1})\mathbf{\omega}' - 0.1] = 0
$$

Set the FOCs to zero yields the optimal solution of the weight:

\begin{eqnarray}
\frac{\partial L}{\partial \mathbf{\omega}} &=& \Sigma \mathbf{\omega} + \lambda (\mu-r\mathbf{1}) = 0 \\
\frac{\partial L}{\partial \lambda} &=& r + (\mu-r\mathbf{1})\mathbf{\omega}' - 0.1 = 0
\end{eqnarray}

From (1), the optimal weight solution has
\begin{equation}
\mathbf{\omega}^* = -\lambda \Sigma^{-1} (\mu-r\mathbf{1})
\end{equation}

Bring this into (2), we have
\begin{equation}
(\mu-r\mathbf{1})'\mathbf{\omega}^{*} = -\lambda (\mu-r\mathbf{1})'\Sigma^{-1}(\mu-r\mathbf{1}) = 0.1-r
\end{equation}

which yields
\begin{equation}
\lambda^* = -\frac{0.1-r}{(\mu-r\mathbf{1})'\Sigma^{-1}(\mu-r\mathbf{1})}
\end{equation}

Combine (7) with (9), the analytical solution for optimal allocations $\omega^*$ is
$$
\mathbf{\omega}^* = \frac{(0.1-r)\Sigma^{-1}(\mu-r\mathbf{1})}{(\mu-r\mathbf{1})'\Sigma^{-1}(\mu-r\mathbf{1})}
$$

\textcolor{blue}{\bf 2.b } First construct the variance-covariance matrix $\Sigma$ from the correlation matrix. That is,
$$
\Sigma = SRS =
\left(
  \begin{array}{cccc}
0.0049	&	0.00168	&	0.0063	&	0.00546	\\
0.00168	&	0.0144	&	0.01512	&	0.01248	\\
0.0063	&	0.01512	&	0.0324	&	0.04212	\\
0.00546	&	0.01248	&	0.04212	&	0.0676	\\
  \end{array}
\right)
$$

Then calculate the optimal weight for the minimum variance portfolio
$$
\mathbf{\omega}^* = \frac{(0.1-r)\Sigma^{-1}(\mu-r\mathbf{1})'}{(\mu-r\mathbf{1})'\Sigma^{-1}(\mu-r\mathbf{1})} =
\left(
  \begin{array}{cccc}
    0.3957 & 1.0541 & -0.8268 & 0.7313 \\
  \end{array}
\right)'
$$

Finally, the standard deviation of the portfolio is
$$
\sigma_{\Pi} = \sqrt{\omega^{*'}\Sigma\omega^*} = 0.1321
$$

Detailed numerical calculation results could be found in the Appendix Matlab code.

\textcolor{blue}{\bf 2.c } The tangency portfolio is the portfolio that is entirely invested in risky assets and is on the capital market line. The portfolio return $\mu_T$ and weight $\omega_T$ are shown below (detailed derivation is presented in Page 79-83 in M2S2 slices). Let

$$
\left\{
  \begin{array}{rcr}
    A & = & \mathbf{1}'\Sigma^{-1}\mathbf{1} \\
    B & = & \mu'\Sigma^{-1}\mathbf{1} \\
    C & = & \mu'\Sigma^{-1}\mu \\
  \end{array}
\right.
$$

and we have

\begin{eqnarray*}
\mu_t &=& \frac{C-Br}{B-Ar} = \frac{\mu'\Sigma^{-1}\mu - \mu'\Sigma^{-1}\mathbf{1}r}{\mu'\Sigma^{-1}\mathbf{1} - \mathbf{1}'\Sigma^{-1}\mathbf{1}r} = 8.17\% \\
\omega_T &=& \frac{\Sigma^{-1}(\mu-r\mathbf{1})}{B-Ar} = \frac{\Sigma^{-1}(\mu-r\mathbf{1})}{\mu'\Sigma^{-1}\mathbf{1} - \mathbf{1}'\Sigma^{-1}\mathbf{1}r} = \left(
                                       \begin{array}{cccc}
                                         0.2922 & 0.7783 & -0.6105 & 0.5400 \\
                                       \end{array}
                                     \right)' \\
\sigma_T &=& \sqrt{\frac{C-2rB+r^2A}{(B-Ar)^2}} = 9.76\%
\end{eqnarray*}

The slope of capital market line is calculated as

$$
Slope = \frac{\mu_T - r}{\sigma_T} = 0.5298
$$

The slope of the capital market line is the measure of risk-adjusted return representing the excess return (over the risk free rate) per unit of total risk taken in the tangency portfolio. It is also the Sharpe ratio of the tangency portfolio. The slope of this portfolio defines the highest Sharpe ratio an portfolio could have in current investment universe.

\textcolor{blue}{\bf 3.a } The value-at-risk level of tangency portfolio is calculated as

$$
VaR(X) = \omega_T' \mu + Factor \times \sqrt{\omega_T'\Sigma\omega_T}
$$

When the Factor is determined by standard normal distribution, the VaR is

$$
VaR(X) = \omega_T' \mu + \Phi^{-1}(1-99\%) \times \sqrt{\omega_T'\Sigma\omega_T} = -0.1453
$$


\textcolor{blue}{\bf 3.b } When the Factor is determined by standard normal distribution, the VaR is

$$
VaR(X) = \omega_T' \mu + T_30^{-1}(1-99\%) \times \sqrt{\omega_T'\Sigma\omega_T} = -0.1580
$$

which assumes a fatter tail on the loss end of the risk distribution.

\section*{B. Value at Risk on FTSE 100}
\textcolor{blue}{\bf 1 } The calculation process and results are shown in the attached spreadsheet. The $\sigma_{10D,t}$ and $VaR_t$ are output to column D and column E.

\textcolor{blue}{\bf 2 } The calculation process and results are shown in the attached spreadsheet. The $r_{10D,t}$ and the indicator of breach are output to column F and column G. The VaR series is plotted in blue and the breach is indicated in red. There are 26 breaches out of 978 observations. The percentage of the breaches is 2.66\%.

From the graph, the breaches seem not to be independent. Instead, the breaches has clustering behavior. That is, one breach is more likely to follow the other breach. Possible explanation is that the instantaneous equity move is more volatile than the VaR measure, which is calculated from 20 previous days with equal weights. 

Empirically, the conditional probability of breach in VaR for the next period given that a breach was observed for the previous period is calculated as

$$
\mathbb{P}(\mathrm{Breach|Pervious Breach}) = \frac{\mathbb{P}(\mathrm{Breach and Pervious Breach})}{\mathbb{P}(\mathrm{Breach})} = 65.45\%
$$

which means the probability of a breach followed by a breach is about 65\%. Clearly a breach clustering pattern lies in the VaR measurement in this case. 

\section*{C. Stochastic Calculus}
\textcolor{blue}{\bf 1 } Let $Y(t) = F(S_1(t), S_2(t),\ldots,S_N(t))$. By multi-dimensional It$\hat{o}$ Lemma we have
\begin{eqnarray*}
dY(t) &=& \sum_{i=1}^N \frac{\partial F}{\partial S_i} dS_i + \frac{1}{2}\sum_{i,j=1}^N \frac{\partial^2 F}{\partial S_i \partial S_j} dS_i dS_j \\
      &=& \sum_{i=1}^N \frac{\partial F}{\partial S_i}\left(S_i\mu_i dt + S_i \sigma_i dX_i\right) + \frac{1}{2}\sum_{i=1}^N\sum_{j=1}^N \frac{\partial^2 F}{\partial S_i \partial S_j} S_i S_j \rho_{ij} \sigma_i \sigma_j dt \\
      &=& \left[\sum_{i=1}^N \frac{\partial F}{\partial S_i}S_i\mu_i + \frac{1}{2}\sum_{i=1}^N\sum_{j=1}^N \frac{\partial^2 F}{\partial S_i \partial S_j} S_i S_j \rho_{ij} \sigma_i \sigma_j\right] dt  + \sum_{i=1}^N \frac{\partial F}{\partial S_i}S_i \sigma_i dX_i
\end{eqnarray*}

\textcolor{blue}{\bf 2} Using It$\hat{o}$ Lemma yields

\begin{eqnarray*}
dY(t) &=& de^{\sigma X(t) - \frac{1}{2}\sigma^2 t} \\
      &=& \frac{\partial Y}{\partial t} dt + \frac{\partial Y}{\partial X} dX + \frac{1}{2} \frac{\partial^2 Y}{\partial X^2} dX^2 \\
      &=& -\frac{1}{2}\sigma^2 Y(t)dt + \sigma Y(t)dX + \frac{1}{2} \sigma^2 Y(t) dt \\
      &=& \sigma Y(t) dt
\end{eqnarray*}
which is a driftless process. That is, $Y(t)$ is an exponential martingale with the form $Y(t)=Z(t)g(t)dX(t)$, where $Z(t) = Y(t)$ and $g(t) = \sigma$.

\textcolor{blue}{\bf 3 } Let $Z(t)=\sqrt{t}X(t)$. To check that $Y(t)$ is a martingale, it is enough to check that the drift of $Z(t)$ is equal to $\int_0^t \frac{X(s)}{2\sqrt{s}}ds$.

Applying It$\hat{o}$ Lemma yields
$$
dZ(t) = \frac{X(t)}{2\sqrt{t}}dt + \sqrt{t}dX(t)
$$
with Z(0) = 0.

Integrate over $[0,t]$ we have

$$
Z(t) = \int_0^t \frac{X(s)}{2\sqrt{s}}ds + \int_0^t \sqrt{s}dX(s)
$$

As required, the drift of $Z(t)$ is equal to $\int_0^t \frac{X(s)}{2\sqrt{s}}ds$. Hence

$$
Y(t) = \int_0^t \sqrt{s}dX(s)
$$
and $Y(t)$ is a martingale.

\textcolor{blue}{\bf 4.a } Starting with the lower triangular matrix $A$, we have

$$
\Sigma = AA' =
\left(
  \begin{array}{cc}
    \sigma_1 & 0 \\
    \rho \sigma_2 & \sqrt{1-\rho^2}\sigma_2 \\
  \end{array}
\right)
\left(
  \begin{array}{cc}
    \sigma_1 & \rho \sigma_2 \\
    0 & \sqrt{1-\rho^2}\sigma_2 \\
  \end{array}
\right)
=
\left(
  \begin{array}{cc}
    \sigma_1^2 & \rho \sigma_1 \sigma_2 \\
    \rho \sigma_1 \sigma_2 & \sigma_2^2 \\
  \end{array}
\right)
$$
which yields the original covariance matrix.

\textcolor{blue}{\bf 4.b } Given $Y = AX$,
$$
\left(
  \begin{array}{c}
    Y_1 \\
    Y_2 \\
  \end{array}
\right)
=
\left(
  \begin{array}{cc}
    \sigma_1 & 0 \\
    \rho \sigma_2 & \sqrt{1-\rho^2}\sigma_2 \\
  \end{array}
\right)
\left(
  \begin{array}{c}
    X_1 \\
    X_2 \\
  \end{array}
\right)
=
\left(
  \begin{array}{c}
    \sigma_1 X_1 \\
    \rho \sigma_2 X_1 + \sqrt{1-\rho^2} \sigma_2 X_2 \\
  \end{array}
\right)
$$

\textcolor{blue}{\bf 4.c } Yes, $Y(t)$ keeps the properties of the Brownian motion if $X_1(t)$ and $X_2(t)$ are random normal. We have

$$
dY_2(t) = \rho \sigma_2 dX_1(t) + \sqrt{1-\rho^2} \sigma_2 dX_2(t)
$$

Firstly, the increment of $Y_2(t)$ will be a random Normal, since it is the summation of two random Normals. Without the loss of generality, let $dX_1 \sim N(0,1)$ and $dX_2 \sim N(0,1)$. Then $\mu_{dY_2} = 0$ and $\sigma_{Y_2} = \rho^2\sigma_2^2 + 1 - \rho^2\sigma_2^2 = 1$. Therefore $dY_2 \sim N(0,1)$. That is, the increment of $Y_2(t)$ retains the properties of Brownian motion.

\section*{Matlab code}
\begin{spacing}{0.9}
\lstinputlisting[language=Matlab]{parta.m}
\end{spacing}

\end{document} 